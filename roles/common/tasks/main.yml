- name: Set timezone
  ansible.builtin.timezone:
    name: "{{ common_timezone }}"

- name: Set hostname
  ansible.builtin.hostname:
    name: dansu

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade packages (safe/full)
  ansible.builtin.apt:
    upgrade: "{{ 'full' if common_apt_upgrade_mode == 'full' else 'safe' }}"

- name: Install base packages
  ansible.builtin.apt:
    name: "{{ common_base_packages }}"
    state: present

# --- SSH hardening (через drop-in, чтобы не перетирать дефолтный sshd_config)
- name: Deploy sshd hardening drop-in
  ansible.builtin.template:
    src: sshd_hardening.conf.j2
    dest: /etc/ssh/sshd_config.d/90-common-hardening.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart ssh

- name: Validate sshd config
  ansible.builtin.command: sshd -t
  changed_when: false

# --- Firewall nftables
- name: Deploy nftables ruleset
  ansible.builtin.template:
    src: nftables.conf.j2
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reload nftables

- name: Enable nftables service
  ansible.builtin.systemd:
    name: nftables
    enabled: true
    state: started

# --- unattended-upgrades
- name: Configure 20auto-upgrades
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: "0644"
  when: common_enable_unattended_upgrades

- name: Configure 50unattended-upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: "0644"
  when: common_enable_unattended_upgrades

# --- fail2ban (минимальный)
- name: Enable and start fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  when: common_enable_fail2ban
